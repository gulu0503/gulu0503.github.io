---
layout: post
title: "多執行緒、同步與非同步、阻塞與非阻塞"
subtitle: 'IoC容器'
author: "Gulu"
header-style: text
tags:
  - 多執行緒
  - 非同步
---


> 假設現在是在餐廳做飯，有兩件任務(Task)要做－「煮雞蛋」和「烤吐司」。

## 單執行緒與多執行緒
- 單執行緒 - 由一個廚師單獨完成「煮雞蛋」和「烤吐司」。
- 多執行緒 - 由多個廚師合力完成「煮雞蛋」和「烤吐司」。

> 再講同步與非同步前，我們的任務狀態變化會像是這樣「開始=>進行中=>完成」，如下：
> - 煮雞蛋：開始煮雞蛋=>煮雞蛋進行中=>煮雞蛋完成
> - 烤吐司：開始烤吐司=>烤吐司進行中=>烤吐司完成

## 同步與非同步
- 同步 - 「開始煮雞蛋」，並在確定「煮雞蛋完成」後，才「開始烤吐司」。
- 非同步 - 「開始煮雞蛋」，並且在尚未「煮雞蛋完成」時，就「開始烤吐司」。

~~前面的單執行緒、多執行緒和同步、非同步的比較很顯然大部份是廢話，~~總結一下前面的例子：
- 單執行緒或多執行緒關注的是「工作者」，有一個或多個工作者在工作。
- 同步與非同步關注的是「任務」，需不需要等待前一個任務完成，再進行下一個任務。

## 單執行緒、多執行緒與同步、非同步
現在我們把執行緒和同步的概念合在一起，同時關注「工作者」和「任務」。
- 單執行緒
  - 單執行緒且同步：由一名廚師「開始煮雞蛋」，並在確定「煮雞蛋完成」後，才「開始烤吐司」。
  - 單執行緒且非同步：由一名廚師「開始煮雞蛋」，並且在尚未「煮雞蛋完成」時，就「開始烤吐司」。
- 多執行緒（由廚師A負責煮雞蛋，廚師B負責烤吐司）
  - 多執行緒且同步：廚師A「開始煮雞蛋」，廚師B在確定廚師A的任務狀態為「煮雞蛋完成」後，才「開始烤吐司」。
  - 多執行緒且非同步：廚師A「開始煮雞蛋」，廚師B「開始烤吐司」，兩個廚師都不互相等待。

從上面的幾個例子我們可以知道：
1. 多執行緒和非同步是不同的概念。
2. 多執行緒可以做為達到非同步的一個手段，但是單執行緒依然可以做到非同步。



## 非同步非阻塞
### C10K問題
假設我們今天需要烤10000片土司，我們就配置10000個廚師來分別料理會發生什麼問題呢？
1. 把廚師都進來餐廳，即便沒有在工作，也會佔了餐廳的空間（記憶體空間），甚至有可能會超過所能容納的空間。
2. 廚房是有限的，要安排這麼多的廚師排隊使用廚房也會造成很大的效率損耗（執行緒調度，Thread Scheduling）。
3. ....

早期的Server是基於處理序/執行緒模型的，新來一個TCP連接就需要分配一個處理序，在一開始Server同時在線上的使用者可能最多只有100人的情況下沒有C10k的問題(同時連接到Server的Client數量超過10000)。

但隨著網際網路的發展，C10k的問題就開始浮現出來，最開始的解決方法是基於事件循環機制的「非同步非阻塞」回調。

### 同步、非同步與阻塞、非阻塞
> 這邊舉網路看到的一個例子－煮開水，來解釋同步與阻塞。
- 同步阻塞 - 小明把水壺放在火上，然後他站在旁邊一直等著水燒開。
- 同步非阻塞 - 小明把水壺放在火上，然後小明就先去做其他事情(像是打掃或洗衣服)，但是在這個過程中，他時不時的回廚房看水燒開了沒。

前面的例子，小明一直呆站在水壺旁邊等著水燒開，而不能先去做其他事情，就是「阻塞」。

> 小明覺得「同步阻塞」的方式太浪費他的時間了，而「同步非阻塞」的方式他要一直回去廚房看水壺也影響了他工作的效率。
> 於是小明把水壺換成笛音壺(水燒開會響的水壺)來試試看會不會比較好。

- 非同步阻塞 - 小明把水壺放在火上，然後他站在旁邊一直等著水壺響水燒開。

> 小明覺得這樣換水壺沒什麼意義，跟「同步阻塞」的方式一樣浪費時間，於是他又換了個做法。

- 非同步非阻塞 - 小明把水壺放在火上，然後小明就先去做其他事情(像是打掃或洗衣服)，等到水壺響了後小明再回去廚房。


在前面的這個例子中，小明是呼叫者，而燒開水是被他調用的任務。

阻塞或是非阻塞是對於小明而言－小明在調用任務後，如果什麼事都不能做，必須等待任務結束後才能做其他事，那就是阻塞。

而同步或非同步是對燒開水這個任務而言－如果小明調用任務後需要主動地等待，那就是同步；如果調用任務後，由任務來通知小明（水燒開時笛音壺發出聲響），則是非同步。

## 非同步非阻塞解決C10K問題
我們現在把非同步非阻塞的概念套用到前面烤10000片土司的問題看看。



## 參考資料
- [Asynchronous, Multi-Threaded Programming With Example In C#
](https://www.c-sharpcorner.com/blogs/asynchronous-multithreaded-programming-with-example-in-c-sharp)
- [同步非同步和阻塞非阻塞的理解
](https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/88862/)
- [並發和並行，異步與多線程區別
](https://blog.csdn.net/woliuyunyicai/article/details/45165869)
- [There Is No Thread
](https://blog.stephencleary.com/2013/11/there-is-no-thread.html)

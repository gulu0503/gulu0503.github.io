---
layout: post
title: "單執行緒與多執行緒、同步與非同步、阻塞與非阻塞（二）"
subtitle: '同步與非同步、阻塞與非阻塞'
author: "Gulu"
header-style: text
tags:
  - 多執行緒
  - 非同步
---

## 非同步非阻塞
### C10K問題
假設我們今天需要同時烤10000片土司，我們就配置10000個廚師來分別料理會發生什麼問題呢？
1. 把廚師都進來餐廳，即便沒有在工作，也會佔了餐廳的空間（記憶體空間）。
2. 廚房的工作區是有限的，要安排這麼多的廚師排隊使用廚房的工作區也會造成很大的效率損耗（執行緒調度，Thread Scheduling）。
3. ....

早期的Server是基於處理序/執行緒模型的，新來一個TCP連接就需要分配一個處理序，在一開始Server同時在線上的使用者可能最多只有100人的情況下，這個模式運作的很正常。

但隨著網際網路的發展，C10k(同時連接到Server的Client數量超過10000)的問題就開始浮現出來，最開始的解決方法是基於事件循環機制的「非同步非阻塞」回調。

### 同步、非同步與阻塞、非阻塞
這邊舉網路常看到的一個例子－「煮開水」，來解釋同步與阻塞。
- 同步阻塞 - 小明把水壺放在火上，然後他站在旁邊一直等著水燒開。
- 同步非阻塞 - 小明把水壺放在火上，然後小明就先去做其他事情(像是打掃或洗衣服)，但是在這個過程中，他時不時的回廚房看水燒開了沒。

前面的例子，小明一直呆站在水壺旁邊等著水燒開，而不能先去做其他事情，就是「阻塞」。

*小明覺得「同步阻塞」的方式太浪費他的時間了，而「同步非阻塞」的方式他要一直回去廚房看水壺也影響了他工作的效率。
於是小明把水壺換成笛音壺(水燒開會響的水壺)來試試看會不會比較好。*

- 非同步阻塞 - 小明把水壺放在火上，然後他站在旁邊一直等著水壺響水燒開。

*小明覺得這樣換水壺沒什麼意義，跟「同步阻塞」的方式一樣浪費時間，於是他又換了個做法。*

- 非同步非阻塞 - 小明把水壺放在火上，然後小明就先去做其他事情(像是打掃或洗衣服)，等到水壺響了後小明再回去廚房。


在前面的這個例子中，小明是呼叫者，而燒開水是被他調用的任務。

阻塞或是非阻塞是對於小明而言－小明在調用任務後，如果什麼事都不能做，必須等待任務結束後才能做其他事，那就是阻塞。

而同步或非同步是對燒開水而言－如果小明調用任務後需要主動地等待，那就是同步；如果調用任務後，由任務來通知小明（水燒開時笛音壺發出聲響），則是非同步。

## 非同步非阻塞解決C10K問題
接著，我們把「非同步非阻塞」的概念套用到前面同時烤10000片吐司的問題看看。

### 前置準備
現在我們不需要10000個廚師了，我們只需要一個廚師(一般人可能也做不到，我們假設這個廚師是閃電俠)。

並且我們的吐司機都具有「烤吐司完成」時，發出聲響通知的功能。

### 開始烤吐司
廚師一台一台的讓10000台烤吐司機開始烤吐司，然後廚師可以去隔壁房間做其他事情(ex:掃地)，烤吐司機在「烤吐司完成」時發出聲響通知烤吐司廚師完成。

在前面的例子中：
- 非阻塞：廚師在開始了每一個烤吐司任務後，都可以在繼續進行下一個烤吐司任務或是掃地之類的其他事情，而毋須等待烤吐司任務的完成。
- 非同步：廚師在開始了烤吐司任務後，無論是不是還有其他事情要做，都不需要由廚師本身一直去確認烤吐司任務是否完成，而是由任務本身通知廚師(發出聲響)通知廚師完成。

### 結論
相比於前面使用10000個廚師(執行緒)的例子，非同步非阻塞的方式雖然只使用1個廚師(執行緒)，但是卻可以避免使用10000個廚師造成的問題，減少無謂的資源損耗，以達到更好工作執行效率。


## 參考資料
- [Asynchronous, Multi-Threaded Programming With Example In C#
](https://www.c-sharpcorner.com/blogs/asynchronous-multithreaded-programming-with-example-in-c-sharp)
- [同步非同步和阻塞非阻塞的理解
](https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/88862/)
- [並發和並行，異步與多線程區別
](https://blog.csdn.net/woliuyunyicai/article/details/45165869)
- [There Is No Thread
](https://blog.stephencleary.com/2013/11/there-is-no-thread.html)
